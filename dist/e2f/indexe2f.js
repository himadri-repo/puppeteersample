"use strict";

var _e2fcrwler = require("./e2fcrwler");

//jshint esversion: 6
var cron = require("node-cron");

var express = require("express");

var fs = require("fs");

var datstore = require('../../radharani/e2fdatastore'); //require("babel-core/register");
//require("babel-polyfill");


var uuidv4 = require('uuid/v4');

var moment = require('moment');

//import { loggers } from 'winston';
var app = express();

function login() {
  _e2fcrwler.Logger.log('info', "Logging in ...");

  var e2fcrawler = new _e2fcrwler.E2FCrawler({
    url: '',
    output: 'json'
  });
  var response = e2fcrawler.postData({
    url: 'https://expressdev.ease2fly.com/api/auth/login',
    data: {
      email: "info@oxytra.com",
      pwd: "Sumit@12356"
    }
  });
  response.then(function (data) {
    _e2fcrwler.Logger.log("info", JSON.stringify(data.result));

    _e2fcrwler.Logger.log('info', JSON.stringify(e2fcrawler.finalData));

    var token = data.result.token;
    startProcess(token); //let runid = `${uuidv4()}_${moment().format("DD-MMM-YYYY HH:mm:ss.SSS")}`;
  }).catch(function (error) {
    _e2fcrwler.Logger.log("error", error);
  });
}

function startProcess(token) {
  _e2fcrwler.Logger.log('info', "Starting process ...");

  var e2fcrawler = new _e2fcrwler.E2FCrawler({
    url: '',
    output: 'json',
    token: token
  });
  var response = e2fcrawler.postData({
    url: 'https://expressdev.ease2fly.com/api/destinations/get-destinations-list',
    data: {
      usrId: 109,
      usrType: "N"
    },
    token: token
  });
  response.then(function (data) {
    _e2fcrwler.Logger.log("info", JSON.stringify(data.result));

    _e2fcrwler.Logger.log('info', JSON.stringify(e2fcrawler.finalData));

    var runid = "".concat(uuidv4(), "_").concat(moment().format("DD-MMM-YYYY HH:mm:ss.SSS"));
    datstore.saveCircleBatchData(runid, e2fcrawler.finalData, "", function (rrid) {
      datstore.finalization(rrid, function () {
        _e2fcrwler.Logger.log('info', 'Finished');

        process.removeAllListeners("unhandledRejection");
        process.removeAllListeners('exit');
        process.removeAllListeners();
        return;
      });
      return;
    });
  }).catch(function (error) {
    _e2fcrwler.Logger.log("error", error);
  });
}

var excutionStarted = false;
cron.schedule("*/20 * * * *", function () {
  _e2fcrwler.Logger.log("info", "Cron started");

  if (excutionStarted) {
    _e2fcrwler.Logger.log("info", 'Previous process still running ...');

    return false;
  }

  try {
    excutionStarted = true;
    process.on('unhandledRejection', function (reason, promise) {
      _e2fcrwler.Logger.log('info', 'Unhandled Rejection at:', reason);
    }); //startProcess();

    login();
  } catch (e) {
    _e2fcrwler.Logger.log('error', e);
  } finally {
    excutionStarted = false;
  }
});
app.listen("3232");
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lMmYvaW5kZXhlMmYuanMiXSwibmFtZXMiOlsiY3JvbiIsInJlcXVpcmUiLCJleHByZXNzIiwiZnMiLCJkYXRzdG9yZSIsInV1aWR2NCIsIm1vbWVudCIsImFwcCIsImxvZ2luIiwiTG9nZ2VyIiwibG9nIiwiZTJmY3Jhd2xlciIsIkUyRkNyYXdsZXIiLCJ1cmwiLCJvdXRwdXQiLCJyZXNwb25zZSIsInBvc3REYXRhIiwiZGF0YSIsImVtYWlsIiwicHdkIiwidGhlbiIsIkpTT04iLCJzdHJpbmdpZnkiLCJyZXN1bHQiLCJmaW5hbERhdGEiLCJ0b2tlbiIsInN0YXJ0UHJvY2VzcyIsImNhdGNoIiwiZXJyb3IiLCJ1c3JJZCIsInVzclR5cGUiLCJydW5pZCIsImZvcm1hdCIsInNhdmVDaXJjbGVCYXRjaERhdGEiLCJycmlkIiwiZmluYWxpemF0aW9uIiwicHJvY2VzcyIsInJlbW92ZUFsbExpc3RlbmVycyIsImV4Y3V0aW9uU3RhcnRlZCIsInNjaGVkdWxlIiwib24iLCJyZWFzb24iLCJwcm9taXNlIiwiZSIsImxpc3RlbiJdLCJtYXBwaW5ncyI6Ijs7QUFXQTs7QUFYQTtBQUNBLElBQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLFdBQUQsQ0FBcEI7O0FBQ0EsSUFBTUMsT0FBTyxHQUFHRCxPQUFPLENBQUMsU0FBRCxDQUF2Qjs7QUFDQSxJQUFNRSxFQUFFLEdBQUdGLE9BQU8sQ0FBQyxJQUFELENBQWxCOztBQUNBLElBQU1HLFFBQVEsR0FBR0gsT0FBTyxDQUFDLDhCQUFELENBQXhCLEMsQ0FDQTtBQUNBOzs7QUFFQSxJQUFNSSxNQUFNLEdBQUdKLE9BQU8sQ0FBQyxTQUFELENBQXRCOztBQUNBLElBQU1LLE1BQU0sR0FBR0wsT0FBTyxDQUFDLFFBQUQsQ0FBdEI7O0FBR0E7QUFFQSxJQUFJTSxHQUFHLEdBQUdMLE9BQU8sRUFBakI7O0FBRUEsU0FBU00sS0FBVCxHQUFpQjtBQUNiQyxvQkFBT0MsR0FBUCxDQUFXLE1BQVgsRUFBbUIsZ0JB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QVAsQ0FBVyxPQUFYLEVBQW9Ca0IsS0FBcEI7QUFDSCxHQW5CRDtBQW9CSDs7QUFFRCxJQUFJVSxlQUFlLEdBQUcsS0FBdEI7QUFDQXRDLElBQUksQ0FBQ3VDLFFBQUwsQ0FBYyxjQUFkLEVBQThCLFlBQVc7QUFDckM5QixvQkFBT0MsR0FBUCxDQUFXLE1BQVgsRUFBbUIsY0FBbkI7O0FBQ0EsTUFBRzRCLGVBQUgsRUFBb0I7QUFDaEI3QixzQkFBT0MsR0FBUCxDQUFXLE1BQVgsRUFBbUIsb0NBQW5COztBQUNBLFdBQU8sS0FBUDtBQUNIOztBQUVELE1BQ0E7QUFDSTRCLElBQUFBLGVBQWUsR0FBRyxJQUFsQjtBQUNBRixJQUFBQSxPQUFPLENBQUNJLEVBQVIsQ0FBVyxvQkFBWCxFQUFpQyxVQUFDQyxNQUFELEVBQVNDLE9BQVQsRUFBcUI7QUFDbERqQyx3QkFBT0MsR0FBUCxDQUFXLE1BQVgsRUFBa0IseUJBQWxCLEVBQTZDK0IsTUFBN0M7QUFDSCxLQUZELEVBRkosQ0FLSTs7QUFDQWpDLElBQUFBLEtBQUs7QUFDUixHQVJELENBU0EsT0FBTW1DLENBQU4sRUFBUztBQUNMbEMsc0JBQU9DLEdBQVAsQ0FBVyxPQUFYLEVBQW9CaUMsQ0FBcEI7QUFDSCxHQVhELFNBWVE7QUFDSkwsSUFBQUEsZUFBZSxHQUFHLEtBQWxCO0FBQ0g7QUFDSixDQXRCRDtBQXdCQS9CLEdBQUcsQ0FBQ3FDLE1BQUosQ0FBVyxNQUFYIiwic291cmNlc0NvbnRlbnQiOlsiLy9qc2hpbnQgZXN2ZXJzaW9uOiA2XHJcbmNvbnN0IGNyb24gPSByZXF1aXJlKFwibm9kZS1jcm9uXCIpO1xyXG5jb25zdCBleHByZXNzID0gcmVxdWlyZShcImV4cHJlc3NcIik7XHJcbmNvbnN0IGZzID0gcmVxdWlyZShcImZzXCIpO1xyXG5jb25zdCBkYXRzdG9yZSA9IHJlcXVpcmUoJy4uLy4uL3JhZGhhcmFuaS9lMmZkYXRhc3RvcmUnKTtcclxuLy9yZXF1aXJlKFwiYmFiZWwtY29yZS9yZWdpc3RlclwiKTtcclxuLy9yZXF1aXJlKFwiYmFiZWwtcG9seWZpbGxcIik7XHJcblxyXG5jb25zdCB1dWlkdjQgPSByZXF1aXJlKCd1dWlkL3Y0Jyk7XHJcbmNvbnN0IG1vbWVudCA9IHJlcXVpcmUoJ21vbWVudCcpO1xyXG5cclxuaW1wb3J0IHtMb2dnZXIsIEUyRkNyYXdsZXJ9IGZyb20gJy4vZTJmY3J3bGVyJztcclxuLy9pbXBvcnQgeyBsb2dnZXJzIH0gZnJvbSAnd2luc3Rvbic7XHJcblxyXG5sZXQgYXBwID0gZXhwcmVzcygpO1xyXG5cclxuZnVuY3Rpb24gbG9naW4oKSB7XHJcbiAgICBMb2dnZXIubG9nKCdpbmZvJywgXCJMb2dnaW5nIGluIC4uLlwiKTtcclxuXHJcbiAgICBsZXQgZTJmY3Jhd2xlciA9IG5ldyBFMkZDcmF3bGVyKHt1cmw6ICcnLCBvdXRwdXQ6ICdqc29uJ30pO1xyXG4gICAgbGV0IHJlc3BvbnNlID0gZTJmY3Jhd2xlci5wb3N0RGF0YSh7dXJsOiAnaHR0cHM6Ly9leHByZXNzZGV2LmVhc2UyZmx5LmNvbS9hcGkvYXV0aC9sb2dpbicsIGRhdGE6IHtcclxuICAgICAgICBlbWFpbDpcImluZm9Ab3h5dHJhLmNvbVwiLFxyXG4gICAgICAgIHB3ZDpcIlN1bWl0QDEyMzU2XCJcclxuICAgIH19KTtcclxuXHJcbiAgICByZXNwb25zZS50aGVuKGRhdGEgPT4ge1xyXG4gICAgICAgIExvZ2dlci5sb2coXCJpbmZvXCIsIEpTT04uc3RyaW5naWZ5KGRhdGEucmVzdWx0KSk7XHJcbiAgICAgICAgTG9nZ2VyLmxvZygnaW5mbycsIEpTT04uc3RyaW5naWZ5KGUyZmNyYXdsZXIuZmluYWxEYXRhKSk7XHJcblxyXG4gICAgICAgIGxldCB0b2tlbiA9IGRhdGEucmVzdWx0LnRva2VuO1xyXG4gICAgICAgIHN0YXJ0UHJvY2Vzcyh0b2tlbik7XHJcbiAgICAgICAgLy9sZXQgcnVuaWQgPSBgJHt1dWlkdjQoKX1fJHttb21lbnQoKS5mb3JtYXQoXCJERC1NTU0tWVlZWSBISDptbTpzcy5TU1NcIil9YDtcclxuICAgIH0pXHJcbiAgICAuY2F0Y2goZXJyb3IgPT4ge1xyXG4gICAgICAgIExvZ2dlci5sb2coXCJlcnJvclwiLCBlcnJvcik7XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gc3RhcnRQcm9jZXNzKHRva2VuKSB7XHJcbiAgICBMb2dnZXIubG9nKCdpbmZvJywgXCJTdGFydGluZyBwcm9jZXNzIC4uLlwiKTtcclxuXHJcbiAgICBsZXQgZTJmY3Jhd2xlciA9IG5ldyBFMkZDcmF3bGVyKHt1cmw6ICcnLCBvdXRwdXQ6ICdqc29uJywgdG9rZW46IHRva2VufSk7XHJcbiAgICBsZXQgcmVzcG9uc2UgPSBlMmZjcmF3bGVyLnBvc3REYXRhKHt1cmw6ICdodHRwczovL2V4cHJlc3NkZXYuZWFzZTJmbHkuY29tL2FwaS9kZXN0aW5hdGlvbnMvZ2V0LWRlc3RpbmF0aW9ucy1saXN0JywgZGF0YToge1xyXG4gICAgICAgIHVzcklkOiAxMDksXHJcbiAgICAgICAgdXNyVHlwZTogXCJOXCJcclxuICAgIH0sIHRva2VuOiB0b2tlbn0pO1xyXG5cclxuICAgIHJlc3BvbnNlLnRoZW4oZGF0YSA9PiB7XHJcbiAgICAgICAgTG9nZ2VyLmxvZyhcImluZm9cIiwgSlNPTi5zdHJpbmdpZnkoZGF0YS5yZXN1bHQpKTtcclxuXHJcbiAgICAgICAgTG9nZ2VyLmxvZygnaW5mbycsIEpTT04uc3RyaW5naWZ5KGUyZmNyYXdsZXIuZmluYWxEYXRhKSk7XHJcblxyXG4gICAgICAgIGxldCBydW5pZCA9IGAke3V1aWR2NCgpfV8ke21vbWVudCgpLmZvcm1hdChcIkRELU1NTS1ZWVlZIEhIOm1tOnNzLlNTU1wiKX1gO1xyXG4gICAgICAgIGRhdHN0b3JlLnNhdmVDaXJjbGVCYXRjaERhdGEocnVuaWQsIGUyZmNyYXdsZXIuZmluYWxEYXRhLCBcIlwiLCBmdW5jdGlvbihycmlkKSB7XHJcbiAgICAgICAgICAgIGRhdHN0b3JlLmZpbmFsaXphdGlvbihycmlkLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBMb2dnZXIubG9nKCdpbmZvJywgJ0ZpbmlzaGVkJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5yZW1vdmVBbGxMaXN0ZW5lcnMoXCJ1bmhhbmRsZWRSZWplY3Rpb25cIik7XHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzLnJlbW92ZUFsbExpc3RlbmVycygnZXhpdCcpO1xyXG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5yZW1vdmVBbGxMaXN0ZW5lcnMoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9KTtcclxuICAgIH0pLmNhdGNoKGVycm9yID0+IHtcclxuICAgICAgICBMb2dnZXIubG9nKFwiZXJyb3JcIiwgZXJyb3IpO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbnZhciBleGN1dGlvblN0YXJ0ZWQgPSBmYWxzZTtcclxuY3Jvbi5zY2hlZHVsZShcIiovMjAgKiAqICogKlwiLCBmdW5jdGlvbigpIHtcclxuICAgIExvZ2dlci5sb2coXCJpbmZvXCIsIFwiQ3JvbiBzdGFydGVkXCIpO1xyXG4gICAgaWYoZXhjdXRpb25TdGFydGVkKSB7XHJcbiAgICAgICAgTG9nZ2VyLmxvZyhcImluZm9cIiwgJ1ByZXZpb3VzIHByb2Nlc3Mgc3RpbGwgcnVubmluZyAuLi4nKTtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgdHJ5XHJcbiAgICB7XHJcbiAgICAgICAgZXhjdXRpb25TdGFydGVkID0gdHJ1ZTtcclxuICAgICAgICBwcm9jZXNzLm9uKCd1bmhhbmRsZWRSZWplY3Rpb24nLCAocmVhc29uLCBwcm9taXNlKSA9PiB7XHJcbiAgICAgICAgICAgIExvZ2dlci5sb2coJ2luZm8nLCdVbmhhbmRsZWQgUmVqZWN0aW9uIGF0OicsIHJlYXNvbik7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy9zdGFydFByb2Nlc3MoKTtcclxuICAgICAgICBsb2dpbigpO1xyXG4gICAgfVxyXG4gICAgY2F0Y2goZSkge1xyXG4gICAgICAgIExvZ2dlci5sb2coJ2Vycm9yJywgZSk7XHJcbiAgICB9XHJcbiAgICBmaW5hbGx5IHtcclxuICAgICAgICBleGN1dGlvblN0YXJ0ZWQgPSBmYWxzZTtcclxuICAgIH1cclxufSk7XHJcblxyXG5hcHAubGlzdGVuKFwiMzIzMlwiKTtcclxuIl19