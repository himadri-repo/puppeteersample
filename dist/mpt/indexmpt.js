"use strict";

var _mptcrwler = require("./mptcrwler");

//jshint esversion: 6
var cron = require("node-cron");

var express = require("express");

var fs = require("fs");

var datstore = require('../../radharani/mptdatastore'); //require("babel-core/register");
//require("babel-polyfill");


var uuidv4 = require('uuid/v4');

var moment = require('moment');

//import { loggers } from 'winston';
var app = express();

function login() {
  _mptcrwler.Logger.log('info', "Logging in ...");

  var mptcrawler = new _mptcrwler.MPTCrawler({
    url: '',
    output: 'json'
  });
  var response = mptcrawler.getData({
    url: 'https://fd.metropolitantravels.com/api/flights?_=1557470967694',
    data: {
      email: "info@oxytra.com",
      pwd: "Sumit@12356"
    }
  });
  response.then(function (data) {
    _mptcrwler.Logger.log("info", JSON.stringify(data.result));

    _mptcrwler.Logger.log('info', JSON.stringify(mptcrawler.finalData));

    var token = data.result.token;
    startProcess(token); //let runid = `${uuidv4()}_${moment().format("DD-MMM-YYYY HH:mm:ss.SSS")}`;
  }).catch(function (error) {
    _mptcrwler.Logger.log("error", error);
  });
}

function startProcess(token) {
  _mptcrwler.Logger.log('info', "Starting process ...");

  var mptcrawler = new _mptcrwler.MPTCrawler({
    url: '',
    output: 'json',
    token: token
  });
  var response = mptcrawler.getData({
    url: 'https://fd.metropolitantravels.com/api/flights?_=1557470967694',
    data: {
      usrId: 109,
      usrType: "N"
    },
    token: token
  });
  response.then(function (data) {
    _mptcrwler.Logger.log("info", JSON.stringify(data.result));

    _mptcrwler.Logger.log('info', JSON.stringify(mptcrawler.finalData));

    var runid = "".concat(uuidv4(), "_").concat(moment().format("DD-MMM-YYYY HH:mm:ss.SSS"));
    datstore.saveCircleBatchData(runid, mptcrawler.finalData, "", function (rrid) {
      datstore.finalization(rrid, function () {
        _mptcrwler.Logger.log('info', 'Finished');

        process.removeAllListeners("unhandledRejection");
        process.removeAllListeners('exit');
        process.removeAllListeners();
        return;
      });
      return;
    });
  }).catch(function (error) {
    _mptcrwler.Logger.log("error", error);
  });
}

var excutionStarted = false; // cron.schedule("*/20 * * * *", function() {
//     Logger.log("info", "Cron started");
//     if(excutionStarted) {
//         Logger.log("info", 'Previous process still running ...');
//         return false;
//     }

try {
  excutionStarted = true;
  process.on('unhandledRejection', function (reason, promise) {
    _mptcrwler.Logger.log('info', 'Unhandled Rejection at:', reason);
  });
  startProcess(); //login();
} catch (e) {
  _mptcrwler.Logger.log('error', e);
} finally {
  excutionStarted = false;
} // });
// app.listen("3236");
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tcHQvaW5kZXhtcHQuanMiXSwibmFtZXMiOlsiY3JvbiIsInJlcXVpcmUiLCJleHByZXNzIiwiZnMiLCJkYXRzdG9yZSIsInV1aWR2NCIsIm1vbWVudCIsImFwcCIsImxvZ2luIiwiTG9nZ2VyIiwibG9nIiwibXB0Y3Jhd2xlciIsIk1QVENyYXdsZXIiLCJ1cmwiLCJvdXRwdXQiLCJyZXNwb25zZSIsImdldERhdGEiLCJkYXRhIiwiZW1haWwiLCJwd2QiLCJ0aGVuIiwiSlNPTiIsInN0cmluZ2lmeSIsInJlc3VsdCIsImZpbmFsRGF0YSIsInRva2VuIiwic3RhcnRQcm9jZXNzIiwiY2F0Y2giLCJlcnJvciIsInVzcklkIiwidXNyVHlwZSIsInJ1bmlkIiwiZm9ybWF0Iiwic2F2ZUNpcmNsZUJhdGNoRGF0YSIsInJyaWQiLCJmaW5hbGl6YXRpb24iLCJwcm9jZXNzIiwicmVtb3ZlQWxsTGlzdGVuZXJzIiwiZXhjdXRpb25TdGFydGVkIiwib24iLCJyZWFzb24iLCJwcm9taXNlIiwiZSJdLCJtYXBwaW5ncyI6Ijs7QUFXQTs7QUFYQTtBQUNBLElBQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLFdBQUQsQ0FBcEI7O0FBQ0EsSUFBTUMsT0FBTyxHQUFHRCxPQUFPLENBQUMsU0FBRCxDQUF2Qjs7QUFDQSxJQUFNRSxFQUFFLEdBQUdGLE9BQU8sQ0FBQyxJQUFELENBQWxCOztBQUNBLElBQU1HLFFBQVEsR0FBR0gsT0FBTyxDQUFDLDhCQUFELENBQXhCLEMsQ0FDQTtBQUNBOzs7QUFFQSxJQUFNSSxNQUFNLEdBQUdKLE9BQU8sQ0FBQyxTQUFELENBQXRCOztBQUNBLElBQU1LLE1BQU0sR0FBR0wsT0FBTyxDQUFDLFFBQUQsQ0FBdEI7O0FBR0E7QUFFQSxJQUFJTSxHQUFHLEdBQUdMLE9BQU8sRUFBakI7O0FBRUEsU0FBU00sS0FBVCxHQUFpQjtBQUNiQyxvQkFBT0MsR0FBUCxDQUFXLE1BQVgsRUFBbUIsZ0JBQW5COztBQUVBLE1BQUlDLFVBQVUsR0FBRyxJQUFJQyxxQkFBSixDQUFlO0FBQUNDLElBQUFBLEdBQUcsRUFBRSxFQUFOO0FBQVVDLElBQUFBLE1BQU0sRUFBRTtBQUFsQixHQUFmLENBQWpCO0FBQ0EsTUFBSUMsUUFBUSxHQUFHSixVQUFVLENBQUNLLE9BQVgsQ0FBbUI7QUFBQ0gsSUFBQUEsR0FBRyxFQUFFLGdFQUFOO0FBQXdFSSxJQUFBQSxJQUFJLEVBQUU7QUFDNUdDLE1BQUFBLEtBQUssRUFBQyxpQkFEc0c7QUFFNUdDLE1BQUFBLEdBQUcsRUFBQztBQUZ3RztBQUE5RSxHQUFuQixDQUFmO0FBS0FKLEVBQUFBLFFBQVEsQ0FBQ0ssSUFBVCxDQUFjLFVBQUFILElBQUksRUFBSTtBQUNsQlIsc0JBQU9DLEdBQVAsQ0FBVyxNQUFYLEVBQW1CVyxJQUFJLENBQUNDLFNBQUwsQ0FBZUwsSUFBSSxDQUFDTSxNQUFwQixDQUFuQjs7QUFDQWQsc0JBQU9DLEdBQVAsQ0FBVyxNQUFYLEVBQW1CVyxJQUFJLENBQUNDLFNBQUwsQ0FBZVgsVUFBVSxDQUFDYSxTQUExQixDQUFuQjs7QUFFQSxRQUFJQyxLQUFLLEdBQUdSLElBQUksQ0FBQ00sTUFBTCxDQUFZRSxLQUF4QjtBQUNBQyxJQUFBQSxZQUFZLENBQUNELEtBQUQsQ0FBWixDQUxrQixDQU1sQjtBQUNILEdBUEQsRUFRQ0UsS0FSRCxDQVFPLFVBQUFDLEtBQUssRUFBSTtBQUNabkIsc0JBQU9DLEdBQVAsQ0FBVyxPQUFYLEVBQW9Ca0IsS0FBcEI7QUFDSCxHQVZEO0FBV0g7O0FBRUQsU0FBU0YsWUFBVCxDQUFzQkQsS0FBdEIsRUFBNkI7QUFDekJoQixvQkFBT0MsR0FBUCxDQUFXLE1BQVgsRUFBbUIsc0JBQW5COztBQUVBLE1BQUlDLFVBQVUsR0FBRyxJQUFJQyxxQkFBSixDQUFlO0FBQUNDLElBQUFBLEdBQUcsRUFBRSxFQUFOO0FBQVVDLElBQUFBLE1BQU0sRUFBRSxNQUFsQjtBQUEwQlcsSUFBQUEsS0FBSyxFQUFFQTtBQUFqQyxHQUFmLENBQWpCO0FBQ0EsTUFBSVYsUUFBUSxHQUFHSixVQUFVLENBQUNLLE9BQVgsQ0FBbUI7QUFBQ0gsSUFBQUEsR0FBRyxFQUFFLGdFQUFOO0FBQXdFSSxJQUFBQSxJQUFJLEVBQUU7QUFDNUdZLE1BQUFBLEtBQUssRUFBRSxHQURxRztBQUU1R0MsTUFBQUEsT0FBTyxFQUFFO0FBRm1HLEtBQTlFO0FBRy9CTCxJQUFBQSxLQUFLLEVBQUVBO0FBSHdCLEdBQW5CLENBQWY7QUFLQVYsRUFBQUEsUUFBUSxDQUFDSyxJQUFULENBQWMsVUFBQUgsSUFBSSxFQUFJO0FBQ2xCUixzQkFBT0MsR0FBUCxDQUFXLE1BQVgsRUFBbUJXLElBQUksQ0FBQ0MsU0FBTCxDQUFlTCxJQUFJLENBQUNNLE1BQXBCLENBQW5COztBQUVBZCxzQkFBT0MsR0FBUCxDQUFXLE1BQVgsRUFBbUJXLElBQUksQ0FBQ0MsU0FBTCxDQUFlWCxVQUFVLENBQUNhLFNBQTFCLENBQW5COztBQUVBLFFBQUlPLEtBQUssYUFBTTFCLE1BQU0sRUFBWixjQUFrQkMsTUFBTSxHQUFHMEIsTUFBVCxDQUFnQiwwQkFBaEIsQ0FBbEIsQ0FBVDtBQUNBNUIsSUFBQUEsUUFBUSxDQUFDNkIsbUJBQVQsQ0FBNkJGLEtBQTdCLEVBQW9DcEIsVUFBVSxDQUFDYSxTQUEvQyxFQUEwRCxFQUExRCxFQUE4RCxVQUFTVSxJQUFULEVBQWU7QUFDekU5QixNQUFBQSxRQUFRLENBQUMrQixZQUFULENBQXNCRCxJQUF0QixFQUE0QixZQUFNO0FBQzlCekIsMEJBQU9DLEdBQVAsQ0FBVyxNQUFYLEVBQW1CLFVBQW5COztBQUVBMEIsUUFBQUEsT0FBTyxDQUFDQyxrQkFBUixDQUEyQixvQkFBM0I7QUFDQUQsUUFBQUEsT0FBTyxDQUFDQyxrQkFBUixDQUEyQixNQUEzQjtBQUNBRCxRQUFBQSxPQUFPLENBQUNDLGtCQUFSO0FBQ0E7QUFDSCxPQVBEO0FBUUE7QUFDSCxLQVZEO0FBV0gsR0FqQkQsRUFpQkdWLEtBakJILENBaUJTLFVBQUFDLEtBQUssRUFBSTtBQUNkbkIsc0JBQU9DLEdBQVAsQ0FBVyxPQUFYLEVBQW9Ca0IsS0FBcEI7QUFDSCxHQW5CRDtBQW9CSDs7QUFFRCxJQUFJVSxlQUFlLEdBQUcsS0FBdEIsQyxDQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFSSxJQUNBO0FBQ0lBLEVBQUFBLGVBQWUsR0FBRyxJQUFsQjtBQUNBRixFQUFBQSxPQUFPLENBQUNHLEVBQVIsQ0FBVyxvQkFBWCxFQUFpQyxVQUFDQyxNQUFELEVBQVNDLE9BQVQsRUFBcUI7QUFDbERoQyxzQkFBT0MsR0FBUCxDQUFXLE1BQVgsRUFBa0IseUJBQWxCLEVBQTZDOEIsTUFBN0M7QUFDSCxHQUZEO0FBR0FkLEVBQUFBLFlBQVksR0FMaEIsQ0FNSTtBQUNILENBUkQsQ0FTQSxPQUFNZ0IsQ0FBTixFQUFTO0FBQ0xqQyxvQkFBT0MsR0FBUCxDQUFXLE9BQVgsRUFBb0JnQyxDQUFwQjtBQUNILENBWEQsU0FZUTtBQUNKSixFQUFBQSxlQUFlLEdBQUcsS0FBbEI7QUFDSCxDLENBQ0w7QUFFQSIsInNvdXJjZXNDb250ZW50IjpbIi8vanNoaW50IGVzdmVyc2lvbjogNlxyXG5jb25zdCBjcm9uID0gcmVxdWlyZShcIm5vZGUtY3JvblwiKTtcclxuY29uc3QgZXhwcmVzcyA9IHJlcXVpcmUoXCJleHByZXNzXCIpO1xyXG5jb25zdCBmcyA9IHJlcXVpcmUoXCJmc1wiKTtcclxuY29uc3QgZGF0c3RvcmUgPSByZXF1aXJlKCcuLi8uLi9yYWRoYXJhbmkvbXB0ZGF0YXN0b3JlJyk7XHJcbi8vcmVxdWlyZShcImJhYmVsLWNvcmUvcmVnaXN0ZXJcIik7XHJcbi8vcmVxdWlyZShcImJhYmVsLXBvbHlmaWxsXCIpO1xyXG5cclxuY29uc3QgdXVpZHY0ID0gcmVxdWlyZSgndXVpZC92NCcpO1xyXG5jb25zdCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKTtcclxuXHJcbmltcG9ydCB7TG9nZ2VyLCBNUFRDcmF3bGVyfSBmcm9tICcuL21wdGNyd2xlcic7XHJcbi8vaW1wb3J0IHsgbG9nZ2VycyB9IGZyb20gJ3dpbnN0b24nO1xyXG5cclxubGV0IGFwcCA9IGV4cHJlc3MoKTtcclxuXHJcbmZ1bmN0aW9uIGxvZ2luKCkge1xyXG4gICAgTG9nZ2VyLmxvZygnaW5mbycsIFwiTG9nZ2luZyBpbiAuLi5cIik7XHJcblxyXG4gICAgbGV0IG1wdGNyYXdsZXIgPSBuZXcgTVBUQ3Jhd2xlcih7dXJsOiAnJywgb3V0cHV0OiAnanNvbid9KTtcclxuICAgIGxldCByZXNwb25zZSA9IG1wdGNyYXdsZXIuZ2V0RGF0YSh7dXJsOiAnaHR0cHM6Ly9mZC5tZXRyb3BvbGl0YW50cmF2ZWxzLmNvbS9hcGkvZmxpZ2h0cz9fPTE1NTc0NzA5Njc2OTQnLCBkYXRhOiB7XHJcbiAgICAgICAgZW1haWw6XCJpbmZvQG94eXRyYS5jb21cIixcclxuICAgICAgICBwd2Q6XCJTdW1pdEAxMjM1NlwiXHJcbiAgICB9fSk7XHJcblxyXG4gICAgcmVzcG9uc2UudGhlbihkYXRhID0+IHtcclxuICAgICAgICBMb2dnZXIubG9nKFwiaW5mb1wiLCBKU09OLnN0cmluZ2lmeShkYXRhLnJlc3VsdCkpO1xyXG4gICAgICAgIExvZ2dlci5sb2coJ2luZm8nLCBKU09OLnN0cmluZ2lmeShtcHRjcmF3bGVyLmZpbmFsRGF0YSkpO1xyXG5cclxuICAgICAgICBsZXQgdG9rZW4gPSBkYXRhLnJlc3VsdC50b2tlbjtcclxuICAgICAgICBzdGFydFByb2Nlc3ModG9rZW4pO1xyXG4gICAgICAgIC8vbGV0IHJ1bmlkID0gYCR7dXVpZHY0KCl9XyR7bW9tZW50KCkuZm9ybWF0KFwiREQtTU1NLVlZWVkgSEg6bW06c3MuU1NTXCIpfWA7XHJcbiAgICB9KVxyXG4gICAgLmNhdGNoKGVycm9yID0+IHtcclxuICAgICAgICBMb2dnZXIubG9nKFwiZXJyb3JcIiwgZXJyb3IpO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHN0YXJ0UHJvY2Vzcyh0b2tlbikge1xyXG4gICAgTG9nZ2VyLmxvZygnaW5mbycsIFwiU3RhcnRpbmcgcHJvY2VzcyAuLi5cIik7XHJcblxyXG4gICAgbGV0IG1wdGNyYXdsZXIgPSBuZXcgTVBUQ3Jhd2xlcih7dXJsOiAnJywgb3V0cHV0OiAnanNvbicsIHRva2VuOiB0b2tlbn0pO1xyXG4gICAgbGV0IHJlc3BvbnNlID0gbXB0Y3Jhd2xlci5nZXREYXRhKHt1cmw6ICdodHRwczovL2ZkLm1ldHJvcG9saXRhbnRyYXZlbHMuY29tL2FwaS9mbGlnaHRzP189MTU1NzQ3MDk2NzY5NCcsIGRhdGE6IHtcclxuICAgICAgICB1c3JJZDogMTA5LFxyXG4gICAgICAgIHVzclR5cGU6IFwiTlwiXHJcbiAgICB9LCB0b2tlbjogdG9rZW59KTtcclxuXHJcbiAgICByZXNwb25zZS50aGVuKGRhdGEgPT4ge1xyXG4gICAgICAgIExvZ2dlci5sb2coXCJpbmZvXCIsIEpTT04uc3RyaW5naWZ5KGRhdGEucmVzdWx0KSk7XHJcblxyXG4gICAgICAgIExvZ2dlci5sb2coJ2luZm8nLCBKU09OLnN0cmluZ2lmeShtcHRjcmF3bGVyLmZpbmFsRGF0YSkpO1xyXG5cclxuICAgICAgICBsZXQgcnVuaWQgPSBgJHt1dWlkdjQoKX1fJHttb21lbnQoKS5mb3JtYXQoXCJERC1NTU0tWVlZWSBISDptbTpzcy5TU1NcIil9YDtcclxuICAgICAgICBkYXRzdG9yZS5zYXZlQ2lyY2xlQmF0Y2hEYXRhKHJ1bmlkLCBtcHRjcmF3bGVyLmZpbmFsRGF0YSwgXCJcIiwgZnVuY3Rpb24ocnJpZCkge1xyXG4gICAgICAgICAgICBkYXRzdG9yZS5maW5hbGl6YXRpb24ocnJpZCwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgTG9nZ2VyLmxvZygnaW5mbycsICdGaW5pc2hlZCcpO1xyXG5cclxuICAgICAgICAgICAgICAgIHByb2Nlc3MucmVtb3ZlQWxsTGlzdGVuZXJzKFwidW5oYW5kbGVkUmVqZWN0aW9uXCIpO1xyXG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2V4aXQnKTtcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MucmVtb3ZlQWxsTGlzdGVuZXJzKCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KS5jYXRjaChlcnJvciA9PiB7XHJcbiAgICAgICAgTG9nZ2VyLmxvZyhcImVycm9yXCIsIGVycm9yKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG52YXIgZXhjdXRpb25TdGFydGVkID0gZmFsc2U7XHJcbi8vIGNyb24uc2NoZWR1bGUoXCIqLzIwICogKiAqICpcIiwgZnVuY3Rpb24oKSB7XHJcbi8vICAgICBMb2dnZXIubG9nKFwiaW5mb1wiLCBcIkNyb24gc3RhcnRlZFwiKTtcclxuLy8gICAgIGlmKGV4Y3V0aW9uU3RhcnRlZCkge1xyXG4vLyAgICAgICAgIExvZ2dlci5sb2coXCJpbmZvXCIsICdQcmV2aW91cyBwcm9jZXNzIHN0aWxsIHJ1bm5pbmcgLi4uJyk7XHJcbi8vICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4vLyAgICAgfVxyXG5cclxuICAgIHRyeVxyXG4gICAge1xyXG4gICAgICAgIGV4Y3V0aW9uU3RhcnRlZCA9IHRydWU7XHJcbiAgICAgICAgcHJvY2Vzcy5vbigndW5oYW5kbGVkUmVqZWN0aW9uJywgKHJlYXNvbiwgcHJvbWlzZSkgPT4ge1xyXG4gICAgICAgICAgICBMb2dnZXIubG9nKCdpbmZvJywnVW5oYW5kbGVkIFJlamVjdGlvbiBhdDonLCByZWFzb24pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHN0YXJ0UHJvY2VzcygpO1xyXG4gICAgICAgIC8vbG9naW4oKTtcclxuICAgIH1cclxuICAgIGNhdGNoKGUpIHtcclxuICAgICAgICBMb2dnZXIubG9nKCdlcnJvcicsIGUpO1xyXG4gICAgfVxyXG4gICAgZmluYWxseSB7XHJcbiAgICAgICAgZXhjdXRpb25TdGFydGVkID0gZmFsc2U7XHJcbiAgICB9XHJcbi8vIH0pO1xyXG5cclxuLy8gYXBwLmxpc3RlbihcIjMyMzZcIik7XHJcbiJdfQ==